import com.google.common.base.Joiner;
import org.apache.spark.SparkConf;
import org.apache.spark.api.java.JavaRDD;
import org.apache.spark.api.java.JavaSparkContext;
import org.apache.spark.mllib.fpm.AssociationRules;
import org.apache.spark.mllib.fpm.FPGrowth;
import org.apache.spark.mllib.fpm.FPGrowthModel;
import org.apache.commons.lang.StringUtils;
import java.util.*;

public class FpTree {
    private JavaRDD<AssociationRules.Rule<String>> results;
    private HashSet<String> proSkillList=new HashSet<>();
    private HashSet<String> conSkillList=new HashSet<>();
    private HashSet<String> skillList=new HashSet<>();
    private String[] skill={"UI","C","开发经验","Java"};
    private String aimjob="Android开发工程师";
    public static void main(String[] args) {
        SparkConf sparkConf = new SparkConf().setAppName("FPTreemodel");
        sparkConf.setMaster("local");
        JavaSparkContext sc = new JavaSparkContext(sparkConf);
        String[] skilling={"C","编程"};
        FpTree fpt =new FpTree("Android开发工程师",skilling);

        fpt.results = fpt.model(sc,fpt.aimjob);
    }

    public FpTree(String aimjob,String[] skill){
        this.aimjob=aimjob;
        this.skill=skill;
    }
    public JavaRDD<AssociationRules.Rule<String>> model(JavaSparkContext sc,String path){
        JavaRDD<List<String>> transactions = sc.textFile("src/main/java/"+path+".txt")
                .map(s -> {
            String[] tmp= s.split(",");
            List<String> ntmp=new ArrayList<String>();
            for(int i=1;i<tmp.length;i++)
                ntmp.add(tmp[i]);
            return ntmp;
        });
        double minSupport = 0.05;
        int numPartition = -1;
        HashSet<String> hSet = new HashSet<>();
        FPGrowthModel<String> model = new FPGrowth()
                .setMinSupport(minSupport)
                .run(transactions);
        for (FPGrowth.FreqItemset<String> s : model.freqItemsets().toJavaRDD().collect()) {
           // System.out.println("[" + Joiner.on(",").join(s.javaItems()) + "]" + s.freq());
            for(String x : s.javaItems()){
                hSet.add(x);
            }
        }
        this.skillList=hSet;
        AssociationRules rule = new AssociationRules()
                .setMinConfidence(0.15);
        JavaRDD<AssociationRules.Rule<String>>result = rule.run(model.freqItemsets().toJavaRDD());

        result.foreach(x ->
                System.out.println(x));

        boolean IsTCPIP=false;
        for(String rex:this.skill)
            if(rex.equals("TCP/IP"))IsTCPIP=true;
        String combine = new String();
        for(String rex:this.skill)
            combine+=","+rex;

        String[] confstr = new String[5];
        Double[] confdou = new Double[5];
        List<AssociationRules.Rule<String>> newresult = result.collect();
        for(AssociationRules.Rule<String>x:newresult){
            if(judge(x.javaAntecedent().toString(),combine)){
                double conf=x.confidence();
                boolean flag=false;
                String S=x.javaConsequent().toString();
                S=S.substring(1,S.length()-1);
                if(IsTCPIP==true&&S.equals("IP"))continue;
                if(S.equals("计算机"))continue;
                for(String j :this.skill){
                    if(j.equals(S))
                        flag=true;
                }
                if(flag==true)continue;
                for(int i=0;i<5;i++)
                    if(confstr[i]!=null&&confstr[i].equals(S)){
                        flag=true;
                        break;
                    }
                if(flag==true)continue;
                for(int i=0;i<5;i++)
                    if(confdou[i]==null){
                        confdou[i]=conf;
                        confstr[i]=S;
                        flag=true;
                        break;
                    }
                if(flag==true)continue;
                double setmin=1.0;
                int posmin=5;
                for(int i=0;i<5;i++)
                    if(confdou[i]<setmin){
                        posmin=i;
                        setmin=confdou[i];
                    }
                if(confdou[posmin]<conf){
                    confdou[posmin]=conf;
                    confstr[posmin]=S;
                }
            }
        }
        for(int i=0;i<5;i++)
            if(confstr[i]!=null){
                this.conSkillList.add(confstr[i]);
        }

        for(String x :skill){
            if(this.skillList.contains(x))
                this.proSkillList.add(x);
        }

        System.out.println(this.skillList);

        System.out.println("proskill");

        System.out.println(this.proSkillList);

        System.out.println("conskill");

        System.out.println(this.conSkillList);

        return result;
    }

    public boolean judge(String connection,String combine){
        String[] ret = connection.substring(1,connection.length()-1).split(", ");
        for(String res:ret){
            if(!combine.contains(res))
                return false;
        }
        return true;
    }
}